<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dane z MQTT</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      margin: 0;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .button-container {
      text-align: center;
      margin-bottom: 20px;
    }

    button {
      margin: 0 10px;
      padding: 10px 20px;
      background-color: #007BFF;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    .section {
      max-width: 1500px;
      margin: 0 auto 40px;
      display: none;
    }

    .filter-panel {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      display: none;
      max-width: 800px;
      margin: 0 auto 20px;
    }

    .chart-wrapper {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      overflow-x: auto;
    }

    canvas {
      width: 100% !important;
      height: 450px !important;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
    }

    th {
      background-color: #007BFF;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Dane z MQTT</h1>
  <div style="text-align: center; margin-bottom: 20px;">
    <button onclick="toggleFilterPanel()" style="padding: 10px 20px; font-size: 16px;">🔍 Pokaż / Ukryj filtry</button>
  </div>

  <div id="filter-panel" style="display: none; text-align: center; margin-bottom: 20px;">
    <div style="display: inline-flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px;">
      <label>Od: <input type="datetime-local" id="fromTime"></label>
      <label>Do: <input type="datetime-local" id="toTime"></label>
      <button onclick="applyManualFilter()">✅ Filtruj</button>
    </div>

    <div>
      <button onclick="setQuickFilter(1)">🕐 1 min</button>
      <button onclick="setQuickFilter(5)">🕔 5 min</button>
      <button onclick="setQuickFilter(15)">🕖 15 min</button>
      <button onclick="clearFilter()">📄 Pokaż wszystkie</button>
    </div>
  </div>

  <div class="button-container">
    <button onclick="toggleSection('chart-container')">📈 Wykres napięć i prądu</button>
    <button onclick="toggleSection('power-chart-container')">⚡ Wykresy mocy</button>
    <button onclick="toggleSection('table-container')">📋 Tabela danych</button>
  </div>

  <!-- Wykres napięcia i prądu -->
  <div class="section" id="chart-container">
    <div class="chart-wrapper">
      <canvas id="mqttChart"></canvas>
    </div>
  </div>

  <!-- Wykres mocy -->
  <div class="section" id="power-chart-container">
    <div class="chart-wrapper">
      <canvas id="powerChart"></canvas>
    </div>
  </div>

  <!-- Tabela -->
  <div class="section" id="table-container">
    <div class="chart-wrapper">
      <table>
        <thead>
          <tr>
            <th>Czas</th>
            <th>Prąd 1 (A)</th>
              <th>Prąd 2 (A)</th>
              <th>Napięcie (V)</th>
              <th>Moc 1 (W)</th>
              <th>Moc 2 (W)</th>
          </tr>
        </thead>
        <tbody id="dataTableBody">
          <!-- dane będą tu -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let mqttChart, powerChart;
    let filterFrom = null;
    let filterTo = null;
    let filterDurationMinutes = 5;  // domyślny czas filtra (5 minut)
    let manualFilterActive = false; // czy jest ustawiony ręczny filtr?

    function toggleFilterPanel() {
      const panel = document.getElementById("filter-panel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    }

    function updateFilterWindow() {
      if (!manualFilterActive) {
        filterTo = new Date();
        filterFrom = new Date(filterTo.getTime() - filterDurationMinutes * 60 * 1000);

        // Ustaw inputy daty aby były widoczne w UI
        document.getElementById("fromTime").value = filterFrom.toISOString().slice(0,16);
        document.getElementById("toTime").value = filterTo.toISOString().slice(0,16);
      }
      // jeśli jest manualny filtr, nie zmieniamy go tutaj, aktualizuje się tylko fetchDataAndUpdate()
    }

    function clearFilter() {
      manualFilterActive = false;
      filterFrom = null;
      filterTo = null;
      document.getElementById("fromTime").value = '';
      document.getElementById("toTime").value = '';
      fetchDataAndUpdate();
    }

    function applyManualFilter() {
      const fromInput = document.getElementById("fromTime").value;
      const toInput = document.getElementById("toTime").value;

      if (fromInput && toInput) {
        filterFrom = new Date(fromInput);
        filterTo = new Date(toInput);
        manualFilterActive = true;
      } else {
        manualFilterActive = false;
        filterFrom = null;
        filterTo = null;
      }
      fetchDataAndUpdate();
    }

    function setQuickFilter(minutes) {
      filterDurationMinutes = minutes;
      manualFilterActive = false; // szybkie filtry korzystają z ruchomego okna
      updateFilterWindow();
      fetchDataAndUpdate();
    }

    function toggleSection(id) {
      document.querySelectorAll('.section').forEach(div => {
        if (div.id === id) {
          div.style.display = div.style.display === 'block' ? 'none' : 'block';
        } else {
          div.style.display = 'none';
        }
      });
    }

    async function fetchDataAndUpdate() {
      updateFilterWindow();  // aktualizuj zakres filtra jeśli nie jest manualny

      try {
        const res = await fetch('https://proj1-2.onrender.com/api/data');
        const data = await res.json();

        const timestamps = [];
        const currents1 = [];
        const currents2 = [];
        const voltages = [];
        const power1 = [];
        const power2 = [];


        const tableBody = document.getElementById('dataTableBody');
        tableBody.innerHTML = '';

        data.reverse().forEach(entry => {
          const entryDate = new Date(entry.timestamp);

          if (filterFrom && filterTo) {
            if (entryDate < filterFrom || entryDate > filterTo) return;
          }

          const time = entryDate.toLocaleTimeString();
          const voltage = entry.voltage;
          const current1 = entry.current1;
          const current2 = entry.current2;
          const p1 = voltage * current1;
          const p2 = voltage * current2;

          timestamps.push(time);
          currents1.push(current1);
          currents2.push(current2);
          voltages.push(voltage);
          power1.push(p1);
          power2.push(p2);        
      
         const row = `<tr>
  <td>${time}</td>
  <td>${current1.toFixed(2)}</td>
  <td>${current2.toFixed(2)}</td>
  <td>${voltage.toFixed(2)}</td>
  <td>${p1.toFixed(2)}</td>
  <td>${p2.toFixed(2)}</td>
</tr>`;
          tableBody.innerHTML += row;
        });

        if (!mqttChart) {
          mqttChart = new Chart(document.getElementById('mqttChart'), {
            type: 'line',
            data: {
              labels: timestamps,
              datasets: [
            { label: 'Prąd 1 (A)', data: currents1, borderColor: 'red', fill: false },
            { label: 'Prąd 2 (A)', data: currents2, borderColor: 'blue', fill: false },
            { label: 'Napięcie (V)', data: voltages, borderColor: 'green', fill: false }
          ]
        },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } }
            }
          });
        } else {
         mqttChart.data.labels = timestamps;
      mqttChart.data.datasets[0].data = currents1;
      mqttChart.data.datasets[1].data = currents2;
      mqttChart.data.datasets[2].data = voltages;
      mqttChart.update();
        }

        if (!powerChart) {
          powerChart = new Chart(document.getElementById('powerChart'), {
            type: 'line',
            data: {
              labels: timestamps,
              datasets: [
                { label: 'Moc1 (V1×I)', data: power1, borderColor: 'purple', fill: false },
                { label: 'Moc2 (V2×I)', data: power2, borderColor: 'orange', fill: false }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: { y: { beginAtZero: true } }
            }
          });
        } else {
          powerChart.data.labels = timestamps;
          powerChart.data.datasets[0].data = power1;
          powerChart.data.datasets[1].data = power2;
          powerChart.update();
        }
      } catch (error) {
        console.error('Błąd pobierania danych:', error);
      }
    }

    // Inicjalizacja: ustaw domyślny filtr i odśwież dane
    setQuickFilter(filterDurationMinutes);
    setInterval(fetchDataAndUpdate, 1000);
  </script>
</body>
</html>
